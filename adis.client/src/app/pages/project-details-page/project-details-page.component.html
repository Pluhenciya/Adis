<div class="container" *ngIf="project; else loading">
  <div class="project-header">
    <div class="project-card" [class]="project.status">
      <button mat-icon-button class="back-button" routerLink="/" matTooltip="Вернуться к списку проектов">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h3 class="project-title">{{ project.name }}</h3>
      <div class="status-chip" [class]="project.status">
        {{ getStatusLabel(project.status) }}
      </div>
      <div class="details">
        <!-- Даты проектирования -->
        <div class="info-group">
          <span class="main-info-label">Сроки проектирования:</span>
          <div class="info-row">
            <mat-icon class="info-icon">event_available</mat-icon>
            <div class="info-content">
              <span class="info-label">Начало</span>
              <span class="info-value">{{ project.startDate | date: 'dd.MM.yyyy' }}</span>
            </div>
          </div>
          <div class="info-row">
            <mat-icon class="info-icon">event_busy</mat-icon>
            <div class="info-content">
              <span class="info-label">Окончание</span>
              <span class="info-value">{{ project.endDate | date: 'dd.MM.yyyy' }}</span>
            </div>
          </div>
        </div>

        <!-- Даты выполнения (если есть) -->
        <div class="info-group" *ngIf="project.status === ProjectStatus.InExecution 
                                || project.status === ProjectStatus.Completed">
          <span class="main-info-label">Сроки выполнения:</span>
          <div class="info-row">
            <mat-icon class="info-icon">event_available</mat-icon>
            <div class="info-content">
              <span class="info-label">Начало</span>
              <span class="info-value">{{ project.startExecutionDate | date: 'dd.MM.yyyy' }}</span>
            </div>
          </div>
          <div class="info-row">
            <mat-icon class="info-icon">event_busy</mat-icon>
            <div class="info-content">
              <span class="info-label">Окончание</span>
              <span class="info-value">{{ project.endExecutionDate | date: 'dd.MM.yyyy' }}</span>
            </div>
          </div>
        </div>

        <!-- Ответственные -->
        <div class="info-group">
          <span class="main-info-label">Ответственные:</span>
          <div class="info-row">
            <mat-icon class="info-icon">person</mat-icon>
            <div class="info-content">
              <span class="info-label">Руководитель проекта</span>
              <span class="info-value">{{ project.responsiblePerson }}</span>
            </div>
          </div>
          <div class="info-row" *ngIf="project.status === ProjectStatus.InExecution 
                                  || project.status === ProjectStatus.Completed">
            <mat-icon class="info-icon">business</mat-icon>
            <div class="info-content">
              <span class="info-label">Подрядчик</span>
              <span class="info-value">{{ project.contractorName || 'Не указан' }}</span>
            </div>
          </div>
        </div>

        <!-- Локация -->
        <div class="info-group">
          <span class="main-info-label">Местоположение:</span>
          <div class="location">
            <mat-icon>location_on</mat-icon>
            <span class="location-info">
              {{ project.workObject.name }}
            </span>
          </div>
        </div>
      </div>

      <div class="map-toggle">
        <button mat-stroked-button color="primary" (click)="toggleProjectMap()">
          <mat-icon>{{ showMap ? 'map_off' : 'map' }}</mat-icon>
          {{ showMap ? 'Скрыть карту' : 'Показать на карте' }}
        </button>
      </div>

      <!-- Карта проекта -->
      <div class="project-map-container" *ngIf="showMap">
        <div #projectMapRef class="project-map"></div>
        <div *ngIf="!hasGeoData" class="map-error">
          <mat-icon>error_outline</mat-icon>
          <span>Геоданные объекта отсутствуют</span>
        </div>
      </div>

      <!-- Действия -->
      <div class="actions" *appHasRole="['admin', 'projectManager']" [style.display]="(project.status === 'Designing' || authService.isAdmin()) ? 'flex' : 'none'">
        <button mat-mini-fab class="edit-btn" (click)="openProjectForm(project)">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-mini-fab class="delete-btn" (click)="deleteProject(project)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <mat-card class="tasks-card">
    <mat-card-header>
      <mat-card-title class="header-container">
        <div class="header-content">
          <span class="tasks-title">Задачи проекта</span>
          <button mat-stroked-button color="primary" class="add-task-btn" 
          (click)="openAddTaskDialog()" *appHasRole="['admin', 'projectManager']" [style.display]="(project.status === 'Designing' || authService.isAdmin()) ? 'flex' : 'none'">
            <mat-icon>add</mat-icon>
            Добавить задачу
          </button>
        </div>
      </mat-card-title>
    </mat-card-header>

    <div class="tasks-container">
      <div class="task-column" *ngFor="let column of taskColumns">
        <div class="column-header">
          <h3>{{ column.title }}</h3>
          <span class="count-badge">{{ column.count }}</span>
        </div>
        <div class="task-list">
          <!-- Внутри mat-card с классом task-item -->
          <mat-card class="task-item" *ngFor="let task of column.tasks" (click)="openTaskDetails(task)">
            <h4>{{ task.name }}</h4>

            <!-- Статус задачи -->
            <div class="task-status" [class]="task.status">
            </div>

            <!-- Исполнители -->
            <div class="task-meta">
              <div class="meta-group">
                <mat-icon class="meta-icon">person_outline</mat-icon>
                <div class="meta-content">
                  <span class="meta-label">Исполнители</span>
                  <div class="user-list">
                    <span class="user-item" *ngFor="let user of task.performers">
                      {{ user.fullName || user.email }}
                    </span>
                    <span *ngIf="!task.performers?.length" class="empty-state">
                      Не назначены
                    </span>
                  </div>
                </div>
              </div>

              <!-- Проверяющие -->
              <div class="meta-group">
                <mat-icon class="meta-icon">verified_user</mat-icon>
                <div class="meta-content">
                  <span class="meta-label">Проверяющие</span>
                  <div class="user-list">
                    <span class="user-item" *ngFor="let user of task.checkers">
                      {{ user.fullName || user.email }}
                    </span>
                    <span *ngIf="!task.checkers?.length" class="empty-state">
                      Не назначены
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </div>
  </mat-card>
</div>

<ng-template #loading>
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>